<?xml version="1.0" encoding="UTF-8"?>
<!-- 
This file contains definitions of common targets for thrift
-->
<project name="ariadne-thrift">
    <description>This file contains definitions of common targets for thrift</description>
    
    <target name="-check-thrift-props" depends="-init-project">
        <fail unless="workspace.root.dir">Must set workspace.root</fail> 
        <fail message="${workspace.root.dir}/common/ant-thrift.properties doesn't exist, check workspace.root.dir property">
            <condition>
                <not><available file="${workspace.root.dir}/common/ant-thrift.properties"/></not>
            </condition>
        </fail>
        <property file="${workspace.root.dir}/common/ant-thrift.properties"/>
        <fail unless="thrift.compiler.version">Must set thrift.compiler.version</fail>
        <fail unless="src.thrift.dir">Must set src.thrift.dir</fail>
    </target>

    <target name="-check-thrift-compiler" depends="-check-thrift-props">
        <exec executable="thrift" resultproperty="thrift.version.result"
        outputproperty="thrift.version.out" errorproperty="thrift.version.err"
        failifexecutionfails="false" failonerror="false"
        searchpath="true">
        <arg value="-version"/>
    </exec>
        <condition property="thrift.available" value="true">
            <and>
                <isset property="thrift.version.result"/>
                <contains string="${thrift.version.out}" substring="${thrift.compiler.version}" casesensitive="false"/>
            </and>
        </condition>
        <echo message="thrift.available : ${thrift.available}"/>
        <echo message="thrift.version.out : ${thrift.version.out}"/>
        <echo message="thrift.version.err : ${thrift.version.err}"/>
    </target>
    
    <target name="-init-thrift-java" depends="-check-thrift-compiler" if="thrift.available">
          <!-- thrift files -->
        <fileset id="thrift.src.files" dir="${src.thrift.dir}">
            <include name="**/*.thrift"/>
        </fileset>
        <fileset id="thrift.java.dest.files" dir="${src.gen-java.dir}">
            <include name="**/*.java"/>
        </fileset>
        <!-- Determine if thrift generated java is up to date -->
        <mkdir dir="${build.dir}"/>
        <uptodate property="thrift.java.uptodate" targetfile="${build.dir}/thrift_ts_java.temp">
            <srcfiles refid="thrift.src.files"/>
        </uptodate>
    </target>
    
    <target name="-init-thrift-as3" depends="-check-thrift-compiler" if="thrift.available">
          <!-- thrift files -->
        <fileset id="thrift.src.files" dir="${src.thrift.dir}">
            <include name="**/*.thrift"/>
        </fileset>
        <fileset id="thrift.as3.dest.files" dir="${thrift.as3.dest.dir}">
            <include name="**/*.as"/>
        </fileset>
        <!-- Determine if thrift generated java is up to date -->
        <mkdir dir="${build.dir}"/>
        <uptodate property="thrift.as3.uptodate" targetfile="${build.dir}/thrift_ts_as3.temp">
            <srcfiles refid="thrift.src.files"/>
        </uptodate>
    </target>
        
    <target name="-warn-thrift-missing" depends="-check-thrift-compiler" unless="thrift.available">
        <echo level="warning" message="WARNING! Thrift compiler is not avaiable, skipping compilation"/>
    </target>

    <target name="-info-thrift-java-uptodate" depends="-init-thrift-java" if="thrift.java.uptodate">
        <echo level="info" message="Thrift to java compiled files are up to date"/>
    </target>

    <target name="-info-thrift-as3-uptodate" depends="-init-thrift-as3" if="thrift.as3.uptodate">
        <echo level="info" message="Thrift to as3 compiled files are up to date"/>
    </target>

    <target name="compile-thrift-java" depends="-init-thrift-java,-warn-thrift-missing,-info-thrift-java-uptodate" 
    if="thrift.available" unless="thrift.java.uptodate">
        <fail unless="src.gen-java.dir">Must set src.gen-java.dir</fail>
        <echo message="Compiling thrift to java..."/>

        <mkdir dir="${src.gen-java.dir}"/>
        <delete>
            <fileset refid="thrift.java.dest.files"/>
        </delete>

        <apply executable="thrift" resultproperty="thrift.compile.result"
        failifexecutionfails="true" failonerror="true"
        searchpath="true" dir="thrift">
            <arg value="-o"/>
            <arg value=".."/>
            <arg value="--gen"/>
            <arg value="java"/>
            <srcfile/>
            <fileset refid="thrift.src.files"/>
        </apply>

        <touch file="${build.dir}/thrift_ts_java.temp"/>
    </target>

    <target name="compile-thrift-as3" depends="-init-thrift-java,-warn-thrift-missing,-info-thrift-as3-uptodate" 
    if="thrift.available" unless="thrift.as3.uptodate">
        <fail unless="thrift.as3.dest.dir">Must set thrift.as3.dest.dir</fail>
        <echo message="Compiling thrift to as3..."/>

        <mkdir dir="${thrift.as3.dest.dir}"/>
        <delete>
            <fileset refid="thrift.as3.dest.files"/>
        </delete>

        <mkdir dir="${thrift.as3.dest.dir}"/>
        <apply executable="thrift" resultproperty="thrift.compile.result"
        failifexecutionfails="true" failonerror="true"
        searchpath="true" dir="thrift">
            <arg value="-o"/>
            <arg value="${thrift.as3.dest}"/>
            <arg value="--gen"/>
            <arg value="as3"/>
            <srcfile/>
            <fileset refid="thrift.src.files"/>
        </apply>
        <touch file="${build.dir}/thrift_ts_as3.temp"/>
    </target>

</project>
